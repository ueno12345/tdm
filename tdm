#!/bin/bash
# vimé¢¨TUI TODOç®¡ç†ãƒ„ãƒ¼ãƒ«

# ------------------------------
# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
# ------------------------------
show_help() {
  cat <<EOF
Usage: $0 [options]

Options:
  -h, --help        ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
  -d YYYYMMDD       æŒ‡å®šæ—¥ã§TODOã‚’èµ·å‹•ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ä»Šæ—¥ï¼‰
  -b DIR            TODOãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ™ãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæŒ‡å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: \$HOME/Documents/todo_listï¼‰

TUIæ“ä½œä¸€è¦§:
  j/k               ä¸Šä¸‹ç§»å‹•
  h/l               å‰æ—¥/ç¿Œæ—¥åˆ‡æ›¿
  Enter             é¸æŠä¸­ã®ã‚¿ã‚¹ã‚¯å®Œäº†/æœªå®Œäº†åˆ‡æ›¿
  -                 é¸æŠä¸­ã®ã‚¿ã‚¹ã‚¯ã‚’ã€Œè¦‹é€ã‚Šã€ã«å¤‰æ›´
  1                 æœªå®Œäº† [ ] ã«å¤‰æ›´
  2                 é«˜å„ªå…ˆåº¦ [!] ã«å¤‰æ›´
  3                 ä¸­å„ªå…ˆåº¦ [~] ã«å¤‰æ›´
  4                 ä½å„ªå…ˆåº¦ [.] ã«å¤‰æ›´
  a                 ã‚¿ã‚¹ã‚¯è¿½åŠ ï¼ˆã‚¿ã‚°é¸æŠ â†’ å†…å®¹å…¥åŠ›ï¼‰
  f                 ãƒ•ã‚£ãƒ«ã‚¿åˆ‡æ›¿ï¼šå…¨ã¦ / æœªå®Œäº† / å®Œäº†
  q                 ä¿å­˜ã—ã¦çµ‚äº†

è‡ªå‹•è¿½åŠ æ©Ÿèƒ½:
  - ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚¿ã‚¹ã‚¯ï¼ˆå‹¤å‹™å½¢æ…‹ã«å¿œã˜ã¦è‡ªå‹•è¿½åŠ ï¼‰
  - å‰å›æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
  - æœˆå ±ä½œæˆï¼ˆãã®æœˆã®æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆæ™‚ã«è‡ªå‹•è¿½åŠ ï¼‰
  - é€±å ±ä½œæˆï¼ˆãã®é€±ã®æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆæ™‚ã«è‡ªå‹•è¿½åŠ ï¼‰
EOF
  exit 0
}

# ------------------------------
# å¼•æ•°å‡¦ç†
# ------------------------------
BASE_DIR="$HOME/Documents/todo_list"
TODAY=$(date +%Y%m%d)
WORK_TYPE="shukkin"
FILTER_MODE="all"

while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help) show_help ;;
    -d) TODAY="$2"; shift 2 ;;
    -b) BASE_DIR="$2"; shift 2 ;;
    *) echo "Unknown option: $1"; show_help ;;
  esac
done

YEAR_MONTH=${TODAY:0:6}
TODO_DIR="$BASE_DIR/$YEAR_MONTH"
mkdir -p "$TODO_DIR"

TODO_FILE="$TODO_DIR/$TODAY.txt"
NEW_FILE=false
[[ ! -e "$TODO_FILE" ]] && NEW_FILE=true
touch "$TODO_FILE"

# ------------------------------
# å‰å›æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚³ãƒ”ãƒ¼
# ------------------------------
copy_pending_from_last_file() {
  [[ -s "$TODO_FILE" ]] && return
  last_file=$(find "$BASE_DIR" -type f -name "*.txt" ! -path "$TODO_FILE" | sort | tail -n1)
  [[ -z "$last_file" ]] && return
  grep -v '^\[x\]' "$last_file" >> "$TODO_FILE"
}

copy_pending_from_last_file

# ------------------------------
# æ–°è¦ä½œæˆæ™‚ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ãƒ»æœˆå ±ãƒ»é€±å ±ã‚’è¿½åŠ 
# ------------------------------
if $NEW_FILE; then
  # ------------------------------
  # å‹¤å‹™å½¢æ…‹é¸æŠ
  # ------------------------------
  echo "==============================="
  echo "å‹¤å‹™å½¢æ…‹ã‚’é¸ã‚“ã§ãã ã•ã„:"
  echo "1: å‡ºå‹¤  2: åœ¨å®…  3: å‡ºå¼µ"
  echo "==============================="
  read -rp "ç•ªå·ã‚’å…¥åŠ›: " type_choice
  case "$type_choice" in
    1) WORK_TYPE="shukkin" ;;
    2) WORK_TYPE="zaitaku" ;;
    3) WORK_TYPE="syucchou" ;;
    *) WORK_TYPE="shukkin" ;;
  esac

  # å‰å›ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’å¼•ãç¶™ã
  PREV_FILE=$(find "$BASE_DIR" -type f -name "*.txt" | sort | grep -B1 "$TODO_FILE" | head -n1)
  if [[ -f "$PREV_FILE" ]]; then
    grep -E "^\[[^x]\]" "$PREV_FILE" >> "$TODO_FILE"
    echo "" >> "$TODO_FILE"
  fi

  # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚¿ã‚¹ã‚¯
  ROUTINE_FILE="$BASE_DIR/template/routine_${WORK_TYPE}.txt"
  [[ -f "$ROUTINE_FILE" ]] && grep -Fxv -f "$TODO_FILE" "$ROUTINE_FILE" >> "$TODO_FILE"

  # æœˆå ±ï¼ˆãã®æœˆã§æœ€åˆã®TODOä½œæˆæ™‚ã®ã¿ï¼‰
  MONTH_DIR="$BASE_DIR/${TODAY:0:6}"
  FIRST_FILE_THIS_MONTH=$(ls "$MONTH_DIR"/*.txt 2>/dev/null | sort | head -n1)
  if [[ "$FIRST_FILE_THIS_MONTH" == "$TODO_FILE" ]]; then
    echo "[!] æœˆå ±ä½œæˆ" >> "$TODO_FILE"
  fi

  # é€±å ±ï¼ˆãã®é€±ã§æœ€åˆã®TODOä½œæˆæ™‚ã®ã¿ï¼‰
  THIS_WEEK=$(date -d "$TODAY" +%Y%V)
  FIRST_FILE_THIS_WEEK=$(find "$BASE_DIR" -type f -name "*.txt" | sort |
    while read -r f; do
      filedate=$(basename "$f" .txt)
      [[ $(date -d "$filedate" +%Y%V) == "$THIS_WEEK" ]] && { echo "$f"; break; }
    done)
  if [[ "$FIRST_FILE_THIS_WEEK" == "$TODO_FILE" ]]; then
    echo "[!] é€±å ±ä½œæˆ" >> "$TODO_FILE"
  fi
fi

# ------------------------------
# TUIé–¢æ•°
# ------------------------------
clear_screen() { printf "\033[2J\033[H"; }
hide_cursor()  { printf "\033[?25l"; }
show_cursor()  { printf "\033[?25h"; }

# ã‚¿ã‚¹ã‚¯ã®é‡è¦åº¦ã§ã‚½ãƒ¼ãƒˆ
sort_tasks() {
  mapfile -t TASKS < <(
    printf "%s\n" "${TASKS[@]}" |
      awk '
        /^\[!\]/ {p=1}
        /^\[~\]/ {p=2}
        /^\[\.\]/ {p=3}
        /^\[ \]/ {p=4}
        /^\[-\]/ {p=5}
        /^\[x\]/ {p=6}
        {print p " " $0}
      ' | sort -n | cut -d' ' -f2-
  )
}

read_tasks() {
  mapfile -t TASKS < "$TODO_FILE"
  sort_tasks
}

draw_screen() {
  clear_screen

  # ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
  DISPLAY_TASKS=()
  DISPLAY_INDEX_MAP=()
  for i in "${!TASKS[@]}"; do
    t="${TASKS[$i]}"
    [[ -z "$t" ]] && continue
    case "$FILTER_MODE" in
      active) [[ "$t" =~ ^\[x\] ]] && continue ;;
      done)   [[ ! "$t" =~ ^\[x\] ]] && continue ;;
      all) ;;
    esac
    DISPLAY_TASKS+=("$t")
    DISPLAY_INDEX_MAP+=("$i")
  done

  [[ ${#DISPLAY_TASKS[@]} -eq 0 ]] && DISPLAY_TASKS=("ï¼ˆã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰") && DISPLAY_INDEX_MAP=(0)
  [[ $CURSOR -ge ${#DISPLAY_TASKS[@]} ]] && CURSOR=$((${#DISPLAY_TASKS[@]}-1))
  [[ $CURSOR -lt 0 ]] && CURSOR=0

  echo "======================================================="
  printf "                    TODO LIST\n"
  printf "           æ—¥ä»˜: %s  ãƒ•ã‚£ãƒ«ã‚¿: %s\n" "$TODAY" "$FILTER_MODE"
  echo "-------------------------------------------------------"

  for i in "${!DISPLAY_TASKS[@]}"; do
    task="${DISPLAY_TASKS[$i]}"
    prefix="   "
    [ "$i" -eq "$CURSOR" ] && prefix="ğŸ‘‰ "

    case "$task" in
      "[x]"*) color="\033[90m" ;;
      "[-]"*) color="\033[36m" ;;
      "[!]"*) color="\033[31m" ;;
      "[~]"*) color="\033[33m" ;;
      "[.]"*) color="\033[34m" ;;
      "[ ]"*) color="\033[0m" ;;
      *) color="\033[0m" ;;
    esac

    echo -e "${prefix}${color}${task}\033[0m"
  done

  echo "-------------------------------------------------------"
  echo "æ“ä½œ: [h/l]å‰æ—¥/ç¿Œæ—¥  [j/k]ç§»å‹•  [Enter]å®Œäº† [-]è¦‹é€ã‚Š "
  echo "      [a]è¿½åŠ   [f]ãƒ•ã‚£ãƒ«ã‚¿  [1234]ã‚¿ã‚°è¿½åŠ   [q]çµ‚äº†"
  echo "ã‚¿ã‚°: [x]å®Œäº†  [ ]æœªå®Œäº†(1) [!]é«˜(2) [~]ä¸­(3)        "
  echo "      [.]ä½(4) [-]è¦‹é€ã‚Š                              "
  echo "======================================================="
}

toggle_done() {
  [[ ${#DISPLAY_TASKS[@]} -eq 0 ]] && return
  line_index=${DISPLAY_INDEX_MAP[$CURSOR]}
  line="${TASKS[$line_index]}"
  # ã©ã®ã‚¿ã‚°ã§ã‚‚å®Œäº† [x] ã«ã™ã‚‹
  case "$line" in
    "[x]"*) TASKS[$line_index]="[ ]${line:3}" ;;  # å®Œäº†ãªã‚‰æœªå®Œäº†ã«æˆ»ã™
    *) TASKS[$line_index]="[x]${line:3}" ;;
  esac
  sort_tasks
}

mark_pending() {
  [[ ${#DISPLAY_TASKS[@]} -eq 0 ]] && return
  line_index=${DISPLAY_INDEX_MAP[$CURSOR]}
  TASKS[$line_index]="[-]${TASKS[$line_index]:3}"
  sort_tasks
}

delete_task() {
  [[ ${#DISPLAY_TASKS[@]} -eq 0 ]] && return
  line_index=${DISPLAY_INDEX_MAP[$CURSOR]}
  unset 'TASKS[$line_index]'
  TASKS=("${TASKS[@]}")
  ((CURSOR>0)) && ((CURSOR--))
}

save_tasks() {
  sort_tasks
  printf "%s\n" "${TASKS[@]}" > "$TODO_FILE"
}

add_task() {
  show_cursor
  echo "ã‚¿ã‚°ã‚’é¸ã‚“ã§ãã ã•ã„:"
  echo "1: [ ] æœªå®Œäº†  2: [!] é«˜  3: [~] ä¸­  4: [.] ä½  5: [-] è¦‹é€ã‚Š"
  read -rp "ç•ªå·ã‚’å…¥åŠ› (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 1): " tag_choice
  case "$tag_choice" in
    2) tag="[!]" ;;
    3) tag="[~]" ;;
    4) tag="[.]" ;;
    5) tag="[-]" ;;
    *) tag="[ ]" ;;
  esac
  read -rp "ã‚¿ã‚¹ã‚¯å†…å®¹: " newtask
  [[ -n "$newtask" ]] && echo "$tag $newtask" >> "$TODO_FILE" && read_tasks
  hide_cursor
}

change_tag() {
  [[ ${#DISPLAY_TASKS[@]} -eq 0 ]] && return
  newtag=$1
  line_index=${DISPLAY_INDEX_MAP[$CURSOR]}
  TASKS[$line_index]="$newtag${TASKS[$line_index]:3}"
  sort_tasks
}

change_day_existing() {
  direction=$1

  # å…¨ã¦ã®æœˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¦ã‚½ãƒ¼ãƒˆ
  files=( $(find "$BASE_DIR" -type f -name "*.txt" | sort) )
  [[ ${#files[@]} -eq 0 ]] && return

  # ç¾åœ¨ã®æ—¥ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
  current_file="$TODO_FILE"

  # å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã§ç¾åœ¨ä½ç½®ã‚’æ¢ã™
  for i in "${!files[@]}"; do
    if [[ "${files[$i]}" == "$current_file" ]]; then
      if [[ $direction == "prev" && $i -gt 0 ]]; then
        newfile="${files[$((i-1))]}"
      elif [[ $direction == "next" && $i -lt $((${#files[@]}-1)) ]]; then
        newfile="${files[$((i+1))]}"
      fi
      break
    fi
  done

  # æ–°ã—ã„æ—¥ä»˜ã«åˆ‡ã‚Šæ›¿ãˆ
  if [[ -n "$newfile" ]]; then
    TODAY=$(basename "$newfile" .txt)
    YEAR_MONTH=${TODAY:0:6}
    TODO_DIR="$BASE_DIR/$YEAR_MONTH"
    TODO_FILE="$newfile"
    read_tasks
    CURSOR=0
  fi
}

# ------------------------------
# ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
# ------------------------------
main() {
  read_tasks
  CURSOR=0
  hide_cursor
  trap "show_cursor; clear_screen; exit" INT TERM

  keybuf=""
  while true; do
    draw_screen
    read -rsn1 key
    keybuf+="$key"
    [[ "$key" == $'\e' ]] && keybuf="" && continue

    case "$keybuf" in
      h) change_day_existing prev; keybuf="" ;;
      l) change_day_existing next; keybuf="" ;;
      j) ((CURSOR++)); ((CURSOR>=${#DISPLAY_TASKS[@]})) && CURSOR=$((${#DISPLAY_TASKS[@]}-1)); keybuf="" ;;
      k) ((CURSOR--)); ((CURSOR<0)) && CURSOR=0; keybuf="" ;;
      x) delete_task; keybuf="" ;;
      "") toggle_done; keybuf="" ;;
      -) mark_pending; keybuf="" ;;
      a) add_task; keybuf="" ;;
      f)
         case "$FILTER_MODE" in
           all) FILTER_MODE="active" ;;
           active) FILTER_MODE="done" ;;
           done) FILTER_MODE="all" ;;
         esac
         CURSOR=0
         keybuf=""
         ;;
      1) change_tag "[ ]"; keybuf="" ;;
      2) change_tag "[!]"; keybuf="" ;;
      3) change_tag "[~]"; keybuf="" ;;
      4) change_tag "[.]"; keybuf="" ;;
      q) save_tasks; show_cursor; clear_screen; echo "çµ‚äº†ã—ã¾ã—ãŸã€‚"; exit 0 ;;
      *) [[ "${#keybuf}" -gt 2 ]] && keybuf="" ;;
    esac
  done
}

main
